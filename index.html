<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Division</title>
    <!-- Add your CSS file or styles here -->
</head>
<body>
    <form id="team-form">
        <label for="num-teams">Number of Teams:</label>
        <input type="number" id="num-teams" name="num-teams" required>
        <br>
        <label for="file-upload">Upload CSV File:</label>
        <input type="file" id="file-upload" name="file-upload" accept=".csv" required>
        <br>
        <button type="submit">Submit</button>
        <button id="export-btn" style="display:none;">Export as CSV</button>
    </form>
    
    <div id="results">
        <!-- The results will be displayed here -->
    </div>
    
    <!-- Your HTML content will go here -->
    <script>
        // Add a submit event listener to the form
        document.getElementById('team-form').addEventListener('submit', async (event) => {
            // Prevent the form from being submitted in the default manner
            event.preventDefault();

            // Get the number of teams from the input field
            const numTeams = document.getElementById('num-teams').value;

            // Get the file that was uploaded
            const fileUpload = document.getElementById('file-upload').files[0];

            // Check if a file was uploaded
            if (!fileUpload) {
                alert('Please select a CSV file to upload.');
                return;
            }

            processInputFile(fileUpload);
        });

        function processInputFile(file) {
            // Create a FileReader object to read the contents of the uploaded file
            const reader = new FileReader();

            // Add an event listener that triggers when the file has been read
            reader.onload = function (event) {
                // Get the file contents as a string and split it into an array of lines
                const lines = event.target.result.split('\n');

                // Initialize empty arrays to store proficiencies and student IDs/names
                const proficiencies = [];
                const studentIds = [];

                // Loop through each line in the lines array
                for (const line of lines) {
                    // Check if the line is not empty after trimming whitespace
                    if (line.trim() != '') {
                        // Split the line into columns using the comma as a separator
                        const columns = line.split(',');

                        // Add the first column (student ID/name) to the studentIds array
                        studentIds.push(columns[0].trim());

                        // Add the second column (proficiency) to the proficiencies array
                        // after converting it to a floating-point number
                        proficiencies.push(parseFloat(columns[1].trim()));
                    }
                }
            }
                console.log('Student IDs before sending:', studentIds);
                // Call the sendFormData function with the proficiencies and studentIds arrays
                sendFormData(proficiencies, studentIds);
        }


        function sendFormData(proficiencies, studentIds) {
            // Get the number of teams from the input field and convert it to an integer
            const numTeams = parseInt(document.getElementById('num-teams').value);

            // Send a POST request to the Flask server with the JSON data
            fetch('/pick_teams', {
                method: 'POST', // Specify the request method as POST
                headers: {
                    'Content-Type': 'application/json' // Set the content type of the request body
                },
                body: JSON.stringify({ // Convert the input data to a JSON string
                    proficiencies: proficiencies,
                    num_teams: numTeams
                })
            })

            .then(response => response.json()) // Convert the response to a JSON object
            .then(results => {
                console.log('Student IDs after receiving data:', studentIds);
                displayResults(results, studentIds);
            }) // Pass the JSON object and studentIds to the displayResults function
            .catch(error => console.error('Error:', error)); // Log any errors that occur during the process
        }
 

        function displayResults(results, studentIds) {
            console.log('Student IDs in displayResults:', studentIds);
            const teams = results;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            const numTeams = teams[0].length;

            // Initialize team arrays
            let teamArrays = [];
            for (let i = 0; i < numTeams; i++) {
                teamArrays.push([]);
            }

            // Fill team arrays with student IDs
            for (let i = 0; i < teams.length; i++) {
                for (let j = 0; j < numTeams; j++) {
                    if (teams[i][j] === 1) {
                        teamArrays[j].push(studentIds[i]);
                        break;
                    }
                }
            }

            // Display teams
            for (let i = 0; i < teamArrays.length; i++) {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team';

                const teamHeading = document.createElement('h3');
                teamHeading.innerText = `Team ${i + 1}`;
                teamDiv.appendChild(teamHeading);

                const teamList = document.createElement('ul');

                for (let j = 0; j < teamArrays[i].length; j++) {
                    const listItem = document.createElement('li');
                    listItem.innerText = teamArrays[i][j];
                    teamList.appendChild(listItem);
                }

                teamDiv.appendChild(teamList);
                resultsDiv.appendChild(teamDiv);
            }

            // Create a CSV string with the results
            let csvData = 'ID,Proficiency,Team\n';
            for (let i = 0; i < studentIds.length; i++) {
                for (let j = 0; j < teams.length; j++) {
                    if (teams[j][i] === 1) {
                        csvData += `${studentIds[i]},${results.proficiencies[i]},${j + 1}\n`;
                        break;
                    }
                }
            }

            // Add an event listener to the export button
            const exportBtn = document.getElementById('export-btn');
            exportBtn.style.display = 'block'; // Show the export button
            exportBtn.onclick = function () {
                // Create a temporary link element to download the CSV file
                const link = document.createElement('a');
                link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvData);
                link.download = 'teams.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        }                   
    

    </script>

</body>
</html>
