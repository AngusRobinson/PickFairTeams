<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Division</title>
    <!-- Add your CSS file or styles here -->
</head>
<body>
    <form id="team-form">
        <label for="num-teams">Number of Teams:</label>
        <input type="number" id="num-teams" name="num-teams" required>
        <br>
        <label for="file-upload">Upload CSV File:</label>
        <input type="file" id="file-upload" name="file-upload" accept=".csv" required>
        <br>
        <button type="submit">Submit</button>
        <button id="export-btn" style="display:none;">Export as CSV</button>
    </form>
    
    <div id="results">
        <!-- The results will be displayed here -->
    </div>
    
    <!-- Your HTML content will go here -->
    <script>
        // Add a submit event listener to the form
        document.getElementById('team-form').addEventListener('submit', async (event) => {
            // Prevent the form from being submitted in the default manner
            event.preventDefault();

            // Get the number of teams from the input field
            const numTeams = document.getElementById('num-teams').value;

            // Get the file that was uploaded
            const fileUpload = document.getElementById('file-upload').files[0];

            // Check if a file was uploaded
            if (!fileUpload) {
                alert('Please select a CSV file to upload.');
                return;
            }

            processInputFile(fileUpload);
        });

        function processInputFile(file) {
            // Create a FileReader object to read the contents of the uploaded file
            const reader = new FileReader();

            // Add an event listener that triggers when the file has been read
            reader.onload = function (event) {
                // Get the file contents as a string and split it into an array of lines
                const lines = event.target.result.split('\n');

                // Initialize empty arrays to store proficiencies and student IDs/names
                const proficiencies = [];
                const studentIDs = [];

                // Loop through each line in the lines array
                for (const line of lines) {
                    // Check if the line is not empty after trimming whitespace
                    if (line.trim() != '') {
                        // Split the line into columns using the comma as a separator
                        const columns = line.split(',');

                        // Add the first column (student ID/name) to the studentIDs array
                        studentIDs.push(columns[0].trim());

                        // Add the second column (proficiency) to the proficiencies array
                        // after converting it to a floating-point number
                        proficiencies.push(parseFloat(columns[1].trim()));
                    }
                }

                // Call the sendFormData function with the proficiencies and studentIDs arrays
                sendFormData(proficiencies, studentIDs);
            };

            // Read the contents of the uploaded file as text
            reader.readAsText(file);
        }


        function sendFormData(proficiencies, studentIDs) {
            // Get the number of teams from the input field and convert it to an integer
            const numTeams = parseInt(document.getElementById('num-teams').value);

            // Send a POST request to the Flask server with the JSON data
            fetch('/pick_teams', {
                method: 'POST', // Specify the request method as POST
                headers: {
                    'Content-Type': 'application/json' // Set the content type of the request body
                },
                body: JSON.stringify({ // Convert the input data to a JSON string
                    proficiencies: proficiencies,
                    num_teams: numTeams
                })
            })
            .then(response => response.json()) // Convert the response to a JSON object
            .then(results => displayResults(results, studentIDs)) // Pass the JSON object and studentIDs to the displayResults function
            .catch(error => console.error('Error:', error)); // Log any errors that occur during the process
        }


                    
    
        function displayResults(results, studentIDs) {
            // Extract the teams array from the results object
            const teams = results.teams;

            // Get the results div to display the team assignments
            const resultsDiv = document.getElementById('results');

            // Clear any previous results in the results div
            resultsDiv.innerHTML = '';

            // Loop through the teams array
            for (let i = 0; i < teams.length; i++) {
                // Create a new div for the current team and set its class to "team"
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team';

                // Create a heading for the current team and set its text content
                const teamHeading = document.createElement('h3');
                teamHeading.innerText = `Team ${i + 1}`;

                // Add the team heading to the team div
                teamDiv.appendChild(teamHeading);

                // Create an unordered list for the team members
                const teamList = document.createElement('ul');

                // Loop through the students in the current team
                for (let j = 0; j < teams[i].length; j++) {
                    // Check if the student is in the current team (value is 1)
                    if (teams[i][j] === 1) {
                        // Create a list item and set its text content to the student's ID/name
                        const listItem = document.createElement('li');
                        listItem.innerText = studentIDs[j];

                        // Add the list item to the team list
                        teamList.appendChild(listItem);
                    }
                }

                // Add the team list to the team div
                teamDiv.appendChild(teamList);

                // Add the team div to the results div
                resultsDiv.appendChild(teamDiv);
            }
            // Create a CSV string with the results
            let csvData = 'ID,Proficiency,Team\n';
            for (let i = 0; i < studentIds.length; i++) {
                for (let j = 0; j < teams.length; j++) {
                    if (teams[j][i] === 1) {
                        csvData += `${studentIds[i]},${results.proficiencies[i]},${j + 1}\n`;
                        break;
                    }
                }
            }

            // Add an event listener to the export button
            const exportBtn = document.getElementById('export-btn');
            exportBtn.style.display = 'block'; // Show the export button
            exportBtn.onclick = function () {
                // Create a temporary link element to download the CSV file
                const link = document.createElement('a');
                link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvData);
                link.download = 'teams.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        }
    </script>

</body>
</html>
